# Отчет по тестированию

## Выбор инструментария
Для модульного и интеграционного тестирования выбран **pytest** вместе с плагином `pytest-cov`. Pytest позволяет лаконично описывать сценарии тестирования, легко сочетает модульные и интеграционные проверки и поддерживает фикстуры, благодаря которым просто организовать создание тестового приложения Flask и изолированной базы данных SQLite в памяти. Плагин `pytest-cov` используется для отслеживания покрытия кода.

## Фикстуры и окружение
Фикстура `app` в `tests/conftest.py` разворачивает экземпляр приложения через `create_app`, используя конфигурацию `TestConfig` (в памяти SQLite, отключенный CSRF, режим `TESTING`). Через фикстуры `client` и `session` тесты получают HTTP‑клиент Flask и сеанс базы данных.

## Набор тестов
Ниже приведены разработанные проверки. Совокупно они покрывают ключевые пользовательские сценарии, описанные в ТЗ (главная страница, поиск, новости, здоровье сервиса и учетные записи), что составляет более 40 % доступного функционала веб-приложения.

### 1. `tests/test_user_model.py::test_user_password_hashing`
- **Модули**: `models.User`.
- **Назначение**: гарантирует корректность хэширования и проверки пароля.
- **Данные**: создается пользователь с паролем `secret123`.
- **Ожидание**: в базе хранится хэш, а метод `check_password` возвращает `True` для корректного пароля и `False` для неверного.

### 2. `tests/test_user_model.py::test_user_email_validation`
- **Модули**: `models.User`.
- **Назначение**: проверка валидации email.
- **Данные**: адрес без символа `@`.
- **Ожидание**: возбуждается `AssertionError`, что предотвращает сохранение некорректного адреса.

### 3. `tests/test_main_routes.py::test_index_page_shows_recent_published_content`
- **Модули**: `blueprints.main.routes`, `models.News`, `models.Event`.
- **Назначение**: проверяет, что главная выводит 5 последних опубликованных новостей и только публичные события.
- **Данные**: 7 опубликованных новостей (разные даты), черновик новости, 6 публичных и 1 скрытое событие.
- **Ожидание**: на странице отображаются только свежие новости (5 шт.) и только публичные события, черновики скрыты.

### 4. `tests/test_health_endpoint.py::test_health_endpoint_returns_ok`
- **Модули**: `app.create_app` (маршрут `/healthz`).
- **Назначение**: проверка готовности сервиса для мониторинга.
- **Данные**: GET-запрос без параметров.
- **Ожидание**: ответ 200 и JSON `{"status": "ok"}`.

### 5. `tests/test_news_routes.py::test_published_news_detail_renders`
- **Модули**: `blueprints.news.routes`, `models.News`.
- **Назначение**: удостоверяется, что страница новости отображается для опубликованного материала.
- **Данные**: опубликованная новость.
- **Ожидание**: HTTP 200 и наличие заголовка в HTML.

### 6. `tests/test_news_routes.py::test_unpublished_news_returns_404`
- **Модули**: `blueprints.news.routes`, `models.News`.
- **Назначение**: защита от просмотра неопубликованных материалов.
- **Данные**: новость со статусом `is_published=False`.
- **Ожидание**: HTTP 404.

### 7. `tests/test_news_routes.py::test_missing_news_returns_404`
- **Модули**: `blueprints.news.routes`.
- **Назначение**: корректная обработка запроса к отсутствующей новости.
- **Данные**: идентификатор 999.
- **Ожидание**: HTTP 404.

### 8. `tests/test_search_routes.py::test_search_returns_matches_for_all_sections`
- **Модули**: `blueprints.search.routes`, `models.News`, `models.Document`, `models.Deputy`, `models.FAQ`.
- **Назначение**: комплексная проверка поиска по всем сущностям.
- **Данные**: записи с ключевым словом «transparency».
- **Ожидание**: в выдаче присутствуют найденные элементы из каждой категории.

### 9. `tests/test_search_routes.py::test_search_without_query_shows_prompt`
- **Модули**: `blueprints.search.routes`.
- **Назначение**: поведение при пустом запросе.
- **Данные**: GET без параметров.
- **Ожидание**: отображается подсказка о необходимости ввода запроса, список результатов пуст.

## Автотесты в CI/CD
В `Jenkinsfile` добавлен этап `Tests: Pytest`, который в изолированном контейнере `python:3.11-slim` устанавливает зависимости и запускает `pytest` с отчетом о покрытии. Этап выполняется для всех веток и обеспечивает автоматический запуск тестов при каждой сборке.

## Демонстрация успешных и неуспешных прогонов
- **Неуспешный прогон**: для воспроизведения можно временно изменить флаг `is_published` у новости в `tests/test_news_routes.py::test_unpublished_news_returns_404` на `True`. Тест упадет, показав, что маршрут не скрывает черновики.
- **Успешные прогоны**: выполнить `pytest --cov=app --cov=blueprints --cov=models` в любой ветке (`feature/*`, `dev`, `main`). В Jenkins этап `Tests: Pytest` аналогично подтверждает прохождение тестов при сборке веток Feature/Fix, Dev и Prod.

